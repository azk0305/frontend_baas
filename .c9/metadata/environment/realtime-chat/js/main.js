{"filter":false,"title":"main.js","tooltip":"/realtime-chat/js/main.js","undoManager":{"mark":37,"position":37,"stack":[[{"start":{"row":591,"column":7},"end":{"row":591,"column":8},"action":"insert","lines":["#"],"id":98}],[{"start":{"row":537,"column":5},"end":{"row":577,"column":5},"action":"remove","lines":["","","","  /**","   * パスワードリセット関連","   */","","  $(\"#passwordResetModal\").on(\"show.bs.modal\", function(event) {","    // #passwordResetModalが表示される直前に実行する処理","","    // メールアドレスをログインフォームからコピー","    $(\"#password-reset-email\").val( $(\"#login-email\").val() );","","    // モーダルの内容をリセット","    $(\".password-reset__help\").hide();","    $(\".password-reset__submit-button\").removeAttr(\"disabled\");","  });","  $(\"#passwordResetModal\").on(\"shown.bs.modal\", function(event) {","    // #passwordResetModalが表示された直後に実行する処理","","    // メールアドレスの欄にすぐ入力できる状態にする","    $(\"#password-reset-email\").focus();","  });","","  // パスワードリセットフォームが送信されたらリセットを実行","  $(\"#password-reset-form\").submit(function() {","    var email = $(\"#password-reset-email\").val();","    if (email) {","      $(\".password-reset__submit-button\").attr(\"disabled\", \"disabled\");","      $(\".password-reset__help\").hide();","      firebase.auth().sendPasswordResetEmail(email).then(function() {","        $(\"#passwordResetModal\").modal(\"toggle\");","        $(\"#passwordResetEmailSentModal\").modal(\"toggle\");","      }).catch(function(error) {","        $(\".password-reset__help\").text(\"エラー：\" + error.message).fadeIn();","        $(\".password-reset__submit-button\").removeAttr(\"disabled\");","      });","    }","","    return false;","  });"],"id":99}],[{"start":{"row":1,"column":32},"end":{"row":1,"column":33},"action":"insert","lines":[","],"id":100}],[{"start":{"row":1,"column":33},"end":{"row":1,"column":34},"action":"insert","lines":[" "],"id":101},{"start":{"row":1,"column":34},"end":{"row":1,"column":35},"action":"insert","lines":["m"]},{"start":{"row":1,"column":35},"end":{"row":1,"column":36},"action":"insert","lines":["o"]}],[{"start":{"row":1,"column":36},"end":{"row":1,"column":37},"action":"insert","lines":["m"],"id":102},{"start":{"row":1,"column":37},"end":{"row":1,"column":38},"action":"insert","lines":["e"]},{"start":{"row":1,"column":38},"end":{"row":1,"column":39},"action":"insert","lines":["n"]},{"start":{"row":1,"column":39},"end":{"row":1,"column":40},"action":"insert","lines":["t"]}],[{"start":{"row":24,"column":9},"end":{"row":24,"column":17},"action":"remove","lines":["showView"],"id":103},{"start":{"row":24,"column":9},"end":{"row":24,"column":17},"action":"insert","lines":["showView"]}],[{"start":{"row":69,"column":58},"end":{"row":97,"column":1},"action":"remove","lines":["","}","","// ログインのときパスワードが間違っている場合に呼ばれる","function onWrongPassword() {","  resetLoginForm();","  $(\".login__password\").addClass(\"has-error\");","  $(\".login__help\").text(\"正しいパスワードを入力してください\").fadeIn();","}","","// ログインのとき試行回数が多すぎてブロックされている場合に呼ばれる","function onTooManyRequests() {","  resetLoginForm();","  $(\".login__submit-button\").attr(\"disabled\", \"disabled\");","  $(\".login__help\").text(\"試行回数が多すぎます。後ほどお試しください。\").fadeIn();","}","","// ログインのときメールアドレスの形式が正しくない場合に呼ばれる","function onInvalidEmail() {","  resetLoginForm();","  $(\".login__email\").addClass(\"has-error\");","  $(\".login__help\").text(\"メールアドレスを正しく入力してください\").fadeIn();","}","","// その他のログインエラーの場合に呼ばれる","function onOtherLoginError(error) {","  resetLoginForm();","  $(\".login__help\").text(\"エラー：\" + error.message).fadeIn();","}"],"id":104}],[{"start":{"row":282,"column":1},"end":{"row":287,"column":1},"action":"remove","lines":["","","// messageを投稿する","function postMessage(message) {","  firebase.database().ref().child(\"messages/\" + currentRoomName).push(message);","}"],"id":105}],[{"start":{"row":63,"column":1},"end":{"row":69,"column":58},"action":"remove","lines":["","","// ユーザ作成のときパスワードが弱すぎる場合に呼ばれる","function onWeakPassword () {","  resetLoginForm();","  $(\".login__password\").addClass(\"has-error\");","  $(\".login__help\").text(\"6文字以上のパスワードを入力してください\").fadeIn();"],"id":129}],[{"start":{"row":204,"column":5},"end":{"row":204,"column":6},"action":"remove","lines":["a"],"id":130},{"start":{"row":204,"column":4},"end":{"row":204,"column":5},"action":"remove","lines":["$"]}],[{"start":{"row":204,"column":4},"end":{"row":204,"column":5},"action":"insert","lines":["v"],"id":131},{"start":{"row":204,"column":5},"end":{"row":204,"column":6},"action":"insert","lines":["a"]},{"start":{"row":204,"column":6},"end":{"row":204,"column":7},"action":"insert","lines":["r"]}],[{"start":{"row":204,"column":7},"end":{"row":204,"column":8},"action":"insert","lines":[" "],"id":132},{"start":{"row":204,"column":8},"end":{"row":204,"column":9},"action":"insert","lines":["l"]}],[{"start":{"row":204,"column":8},"end":{"row":204,"column":9},"action":"remove","lines":["l"],"id":133}],[{"start":{"row":204,"column":8},"end":{"row":204,"column":9},"action":"insert","lines":["r"],"id":134},{"start":{"row":204,"column":9},"end":{"row":204,"column":10},"action":"insert","lines":["o"]},{"start":{"row":204,"column":10},"end":{"row":204,"column":11},"action":"insert","lines":["o"]},{"start":{"row":204,"column":11},"end":{"row":204,"column":12},"action":"insert","lines":["m"]},{"start":{"row":204,"column":12},"end":{"row":204,"column":13},"action":"insert","lines":["L"]},{"start":{"row":204,"column":13},"end":{"row":204,"column":14},"action":"insert","lines":["i"]},{"start":{"row":204,"column":14},"end":{"row":204,"column":15},"action":"insert","lines":["s"]},{"start":{"row":204,"column":15},"end":{"row":204,"column":16},"action":"insert","lines":["t"]},{"start":{"row":204,"column":16},"end":{"row":204,"column":17},"action":"insert","lines":["i"]}],[{"start":{"row":204,"column":16},"end":{"row":204,"column":17},"action":"remove","lines":["i"],"id":135}],[{"start":{"row":204,"column":16},"end":{"row":204,"column":17},"action":"insert","lines":["L"],"id":136},{"start":{"row":204,"column":17},"end":{"row":204,"column":18},"action":"insert","lines":["i"]},{"start":{"row":204,"column":18},"end":{"row":204,"column":19},"action":"insert","lines":["n"]},{"start":{"row":204,"column":19},"end":{"row":204,"column":20},"action":"insert","lines":["k"]}],[{"start":{"row":211,"column":16},"end":{"row":211,"column":18},"action":"remove","lines":["$a"],"id":137},{"start":{"row":211,"column":16},"end":{"row":211,"column":28},"action":"insert","lines":["roomListLink"]}],[{"start":{"row":213,"column":4},"end":{"row":213,"column":6},"action":"remove","lines":["$a"],"id":138},{"start":{"row":213,"column":4},"end":{"row":213,"column":16},"action":"insert","lines":["roomListLink"]}],[{"start":{"row":233,"column":2},"end":{"row":233,"column":6},"action":"remove","lines":["$div"],"id":143},{"start":{"row":233,"column":2},"end":{"row":233,"column":3},"action":"insert","lines":["v"]},{"start":{"row":233,"column":3},"end":{"row":233,"column":4},"action":"insert","lines":["a"]},{"start":{"row":233,"column":4},"end":{"row":233,"column":5},"action":"insert","lines":["r"]}],[{"start":{"row":233,"column":5},"end":{"row":233,"column":6},"action":"insert","lines":[" "],"id":144},{"start":{"row":233,"column":6},"end":{"row":233,"column":7},"action":"insert","lines":["d"]},{"start":{"row":233,"column":7},"end":{"row":233,"column":8},"action":"insert","lines":["i"]},{"start":{"row":233,"column":8},"end":{"row":233,"column":9},"action":"insert","lines":["v"]},{"start":{"row":233,"column":9},"end":{"row":233,"column":10},"action":"insert","lines":["T"]},{"start":{"row":233,"column":10},"end":{"row":233,"column":11},"action":"insert","lines":["a"]}],[{"start":{"row":233,"column":11},"end":{"row":233,"column":12},"action":"insert","lines":["g"],"id":145}],[{"start":{"row":234,"column":2},"end":{"row":234,"column":6},"action":"remove","lines":["$div"],"id":146},{"start":{"row":234,"column":2},"end":{"row":234,"column":8},"action":"insert","lines":["divTag"]}],[{"start":{"row":242,"column":25},"end":{"row":243,"column":0},"action":"insert","lines":["",""],"id":147},{"start":{"row":243,"column":0},"end":{"row":243,"column":2},"action":"insert","lines":["  "]},{"start":{"row":243,"column":2},"end":{"row":243,"column":3},"action":"insert","lines":["v"]},{"start":{"row":243,"column":3},"end":{"row":243,"column":4},"action":"insert","lines":["a"]},{"start":{"row":243,"column":4},"end":{"row":243,"column":5},"action":"insert","lines":["r"]}],[{"start":{"row":243,"column":5},"end":{"row":243,"column":6},"action":"insert","lines":[" "],"id":148},{"start":{"row":243,"column":6},"end":{"row":243,"column":7},"action":"insert","lines":["d"]},{"start":{"row":243,"column":7},"end":{"row":243,"column":8},"action":"insert","lines":["i"]},{"start":{"row":243,"column":8},"end":{"row":243,"column":9},"action":"insert","lines":["v"]},{"start":{"row":243,"column":9},"end":{"row":243,"column":10},"action":"insert","lines":["T"]}],[{"start":{"row":243,"column":10},"end":{"row":243,"column":11},"action":"insert","lines":["a"],"id":149},{"start":{"row":243,"column":11},"end":{"row":243,"column":12},"action":"insert","lines":["g"]}],[{"start":{"row":243,"column":12},"end":{"row":243,"column":13},"action":"insert","lines":[" "],"id":150},{"start":{"row":243,"column":13},"end":{"row":243,"column":14},"action":"insert","lines":["="]}],[{"start":{"row":243,"column":14},"end":{"row":243,"column":15},"action":"insert","lines":[" "],"id":151},{"start":{"row":243,"column":15},"end":{"row":243,"column":16},"action":"insert","lines":["n"]},{"start":{"row":243,"column":16},"end":{"row":243,"column":17},"action":"insert","lines":["u"]},{"start":{"row":243,"column":17},"end":{"row":243,"column":18},"action":"insert","lines":["l"]},{"start":{"row":243,"column":18},"end":{"row":243,"column":19},"action":"insert","lines":["l"]},{"start":{"row":243,"column":19},"end":{"row":243,"column":20},"action":"insert","lines":[";"]}],[{"start":{"row":245,"column":4},"end":{"row":245,"column":8},"action":"remove","lines":["$div"],"id":152},{"start":{"row":245,"column":4},"end":{"row":245,"column":10},"action":"insert","lines":["divTag"]}],[{"start":{"row":247,"column":4},"end":{"row":247,"column":8},"action":"remove","lines":["$div"],"id":153},{"start":{"row":247,"column":4},"end":{"row":247,"column":10},"action":"insert","lines":["divTag"]}],[{"start":{"row":253,"column":4},"end":{"row":253,"column":8},"action":"remove","lines":["$div"],"id":154},{"start":{"row":253,"column":4},"end":{"row":253,"column":10},"action":"insert","lines":["divTag"]}],[{"start":{"row":255,"column":4},"end":{"row":255,"column":8},"action":"remove","lines":["$div"],"id":155},{"start":{"row":255,"column":4},"end":{"row":255,"column":10},"action":"insert","lines":["divTag"]}],[{"start":{"row":257,"column":6},"end":{"row":257,"column":10},"action":"remove","lines":["$div"],"id":156},{"start":{"row":257,"column":6},"end":{"row":257,"column":12},"action":"insert","lines":["divTag"]}],[{"start":{"row":263,"column":2},"end":{"row":263,"column":6},"action":"remove","lines":["$div"],"id":157},{"start":{"row":263,"column":2},"end":{"row":263,"column":8},"action":"insert","lines":["divTag"]}],[{"start":{"row":265,"column":2},"end":{"row":265,"column":6},"action":"remove","lines":["$div"],"id":158},{"start":{"row":265,"column":2},"end":{"row":265,"column":8},"action":"insert","lines":["divTag"]}],[{"start":{"row":268,"column":2},"end":{"row":268,"column":6},"action":"remove","lines":["$div"],"id":159},{"start":{"row":268,"column":2},"end":{"row":268,"column":8},"action":"insert","lines":["divTag"]}],[{"start":{"row":270,"column":9},"end":{"row":270,"column":13},"action":"remove","lines":["$div"],"id":160},{"start":{"row":270,"column":9},"end":{"row":270,"column":15},"action":"insert","lines":["divTag"]}],[{"start":{"row":113,"column":1},"end":{"row":190,"column":1},"action":"remove","lines":["","","// チャット画面の初期化処理","function loadChatView() {","  resetChatView();","","  dbdata = {}; // キャッシュデータを空にする","","  // ユーザ一覧を取得してさらに変更を監視","  var usersRef = firebase.database().ref(\"users\");","  // 過去に登録したイベントハンドラを削除","  usersRef.off(\"value\");","  // イベントハンドラを登録","  usersRef.on(\"value\", function(usersSnapshot) {","    // usersに変更があるとこの中が実行される","","    dbdata.users = usersSnapshot.val();","","    // 自分のユーザデータが存在しない場合は作成","    if (dbdata.users === null || !dbdata.users[currentUID]) {","      var currentUser = firebase.auth().currentUser;","      if (currentUser) {","        console.log(\"ユーザデータを作成します\");","        firebase.database().ref(\"users/\" + currentUID).set({","          nickname: currentUser.email,","          createdAt: firebase.database.ServerValue.TIMESTAMP,","          updatedAt: firebase.database.ServerValue.TIMESTAMP,","        });","","        // このコールバック関数が再度呼ばれるのでこれ以上は処理しない","        return;","      }","    }","","    for (var uid in dbdata.users) {","      updateNicknameDisplay(uid);","      downloadProfileImage(uid);","    }","","    // usersとroomsが揃ったらルームを表示（初回のみ）","    if (currentRoomName === null && dbdata.rooms) {","      showCurrentRoom();","    }","  });","","  // ルーム一覧を取得してさらに変更を監視","  var roomsRef = firebase.database().ref(\"rooms\");","  // 過去に登録したイベントハンドラを削除","  roomsRef.off(\"value\");","  // コールバックを登録","  roomsRef.on(\"value\", function(roomsSnapshot) {","    // roomsに変更があるとこの中が実行される","","    dbdata.rooms = roomsSnapshot.val();","","    // 初期ルームが存在しない場合は作成する","    if (dbdata.rooms === null || !dbdata.rooms[defaultRoomName]) {","      console.log(defaultRoomName + \"ルームを作成します\");","      firebase.database().ref(\"rooms/\" + defaultRoomName).setWithPriority({","        createdAt: firebase.database.ServerValue.TIMESTAMP,","        createdByUID: currentUID,","      }, 1);","","      // このコールバック関数が再度呼ばれるのでこれ以上は処理しない","      return;","    }","","    // ルーム一覧をナビゲーションメニューに表示","    showRoomList(roomsSnapshot);","","    // usersデータがまだ来ていない場合は何もしない","    if (!dbdata.users) {","      return;","    }","","    showCurrentRoom();","  });","}"],"id":161}],[{"start":{"row":68,"column":3},"end":{"row":145,"column":1},"action":"insert","lines":["","","// チャット画面の初期化処理","function loadChatView() {","  resetChatView();","","  dbdata = {}; // キャッシュデータを空にする","","  // ユーザ一覧を取得してさらに変更を監視","  var usersRef = firebase.database().ref(\"users\");","  // 過去に登録したイベントハンドラを削除","  usersRef.off(\"value\");","  // イベントハンドラを登録","  usersRef.on(\"value\", function(usersSnapshot) {","    // usersに変更があるとこの中が実行される","","    dbdata.users = usersSnapshot.val();","","    // 自分のユーザデータが存在しない場合は作成","    if (dbdata.users === null || !dbdata.users[currentUID]) {","      var currentUser = firebase.auth().currentUser;","      if (currentUser) {","        console.log(\"ユーザデータを作成します\");","        firebase.database().ref(\"users/\" + currentUID).set({","          nickname: currentUser.email,","          createdAt: firebase.database.ServerValue.TIMESTAMP,","          updatedAt: firebase.database.ServerValue.TIMESTAMP,","        });","","        // このコールバック関数が再度呼ばれるのでこれ以上は処理しない","        return;","      }","    }","","    for (var uid in dbdata.users) {","      updateNicknameDisplay(uid);","      downloadProfileImage(uid);","    }","","    // usersとroomsが揃ったらルームを表示（初回のみ）","    if (currentRoomName === null && dbdata.rooms) {","      showCurrentRoom();","    }","  });","","  // ルーム一覧を取得してさらに変更を監視","  var roomsRef = firebase.database().ref(\"rooms\");","  // 過去に登録したイベントハンドラを削除","  roomsRef.off(\"value\");","  // コールバックを登録","  roomsRef.on(\"value\", function(roomsSnapshot) {","    // roomsに変更があるとこの中が実行される","","    dbdata.rooms = roomsSnapshot.val();","","    // 初期ルームが存在しない場合は作成する","    if (dbdata.rooms === null || !dbdata.rooms[defaultRoomName]) {","      console.log(defaultRoomName + \"ルームを作成します\");","      firebase.database().ref(\"rooms/\" + defaultRoomName).setWithPriority({","        createdAt: firebase.database.ServerValue.TIMESTAMP,","        createdByUID: currentUID,","      }, 1);","","      // このコールバック関数が再度呼ばれるのでこれ以上は処理しない","      return;","    }","","    // ルーム一覧をナビゲーションメニューに表示","    showRoomList(roomsSnapshot);","","    // usersデータがまだ来ていない場合は何もしない","    if (!dbdata.users) {","      return;","    }","","    showCurrentRoom();","  });","}"],"id":162}]]},"ace":{"folds":[],"scrolltop":1440,"scrollleft":0,"selection":{"start":{"row":702,"column":0},"end":{"row":702,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":206,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1535621538913,"hash":"abcbef63a980358566cdfb05492a348daef4010d"}